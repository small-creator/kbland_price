<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- 네이버 가이드 기반 최적화된 메타태그 -->
    
    <!-- 페이지 제목 (브랜드명 + 핵심 기능) -->
    <title>전세보증보험 가입조건 확인 | 보증금·융자금 계산기</title>
    
    <!-- 페이지 설명 (80자 이내, 1-2개 문장) -->
    <meta name="description" content="전세보증보험 가입조건을 보증금·융자금으로 즉시 확인! HUG·SGI 보험 가능여부 진단 서비스">
    
    <!-- 키워드 (스팸성 없이 자연스럽게) -->
    <meta name="keywords" content="전세보증보험, 가입조건, 보증금, 융자금, HUG, SGI, 계산기, 확인">
    
    <!-- 오픈그래프 태그 (소셜 공유 + 네이버 검색 활용) -->
    <meta property="og:type" content="website">
    <meta property="og:title" content="전세보증보험 가입조건 확인 | 보증금·융자금 계산기">
    <meta property="og:description" content="전세보증보험 가입조건을 보증금·융자금으로 즉시 확인! HUG·SGI 보험 가능여부 진단 서비스">
    <meta property="og:image" content="https://jeonse-insurance-check.vercel.app/og-image.png">
    <meta property="og:url" content="https://jeonse-insurance-check.vercel.app/">
    <meta property="og:site_name" content="전세보증보험 확인시스템">
    <meta property="og:locale" content="ko_KR">
    
    <!-- 트위터 카드 -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="전세보증보험 가입조건 확인">
    <meta name="twitter:description" content="보증금·융자금으로 HUG·SGI 전세보증보험 가입 가능여부를 즉시 확인하세요">
    <meta name="twitter:image" content="https://jeonse-insurance-check.vercel.app/og-image.png">
    <meta name="twitter:domain" content="전세보증보험 확인시스템">
    
    <!-- 검색엔진 최적화 -->
    <meta name="robots" content="index, follow">
    <meta name="author" content="공인중개사">
    <meta name="language" content="ko-KR">
    <meta name="geo.region" content="KR">
    <meta name="geo.placename" content="Korea">
    
    <!-- 네이버 서치어드바이저 인증 -->
    <meta name="naver-site-verification" content="28e607070335 7b97653a5a898593ee709c031c83">
    
    <!-- 구글 서치콘솔 인증 (등록 후 코드 입력) -->
    <meta name="google-site-verification" content="DLgZhh6tw9ORfVH0KGjGeoDEfVOfmg-OtJu6L6zXDy4">
    
    <!-- Canonical URL -->
    <link rel="canonical" href="https://jeonse-insurance-check.vercel.app/">
    
    <!-- 파비콘 -->
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    
    <!-- 구조화 데이터 (JSON-LD) -->
    <script type="application/ld+json">
    {
        "@context": "https://schema.org",
        "@type": "WebApplication",
        "name": "전세보증보험 가입조건 확인시스템",
        "alternateName": ["전세보증보험 확인", "전세보험 계산기", "HUG SGI 보험확인"],
        "description": "전세보증보험 가입조건을 보증금과 융자금으로 즉시 확인하는 무료 서비스",
        "url": "https://jeonse-insurance-check.vercel.app/",
        "applicationCategory": "FinanceApplication",
        "operatingSystem": "Web Browser",
        "inLanguage": "ko-KR",
        "offers": {
            "@type": "Offer",
            "price": "0",
            "priceCurrency": "KRW",
            "description": "무료 전세보증보험 가입조건 확인 서비스"
        },
        "featureList": [
            "전세보증보험 가입조건 확인",
            "보증금 및 융자금 계산",
            "HUG, SGI 보증보험 비교",
            "즉시 가입 가능여부 진단"
        ],
        "publisher": {
            "@type": "Organization",
            "name": "전세보증보험 확인시스템"
        },
        "potentialAction": {
            "@type": "UseAction",
            "target": "https://jeonse-insurance-check.vercel.app/",
            "object": "전세보증보험 가입조건 확인"
        }
    }
    </script>

    <style>
        /* 기존 CSS는 그대로 유지 */
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            font-weight: 700;
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .search-section {
            padding: 40px;
        }

        .search-row {
            display: flex;
            gap: 20px;
            margin-bottom: 30px;
            align-items: center;
            flex-wrap: wrap;
        }

        .search-group {
            flex: 1;
            min-width: 200px;
        }

        .search-group label {
            display: block;
            font-weight: 600;
            color: #333;
            margin-bottom: 8px;
            font-size: 0.95rem;
        }

        .search-group select {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e1e8ed;
            border-radius: 10px;
            font-size: 1rem;
            background: white;
            transition: all 0.3s ease;
            appearance: none;
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 12px center;
            background-repeat: no-repeat;
            background-size: 16px;
            padding-right: 40px;
        }

        .search-group select:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .search-group select:disabled {
            background-color: #f9fafb;
            color: #9ca3af;
            cursor: not-allowed;
        }

        .btn {
            padding: 12px 24px;
            background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 120px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(59, 130, 246, 0.3);
        }

        .btn:disabled {
            background: #9ca3af;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .results-section {
            margin-top: 30px;
            padding: 20px;
            border: 2px solid #e5e7eb;
            border-radius: 15px;
            background: #f8fafc;
            display: none;
        }

        .results-section.show {
            display: block;
        }

        .complex-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .complex-item {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            border: 2px solid transparent;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .complex-item:hover {
            border-color: #3b82f6;
            transform: translateY(-2px);
            box-shadow: 0 8px 15px rgba(0,0,0,0.15);
        }

        .complex-name {
            font-size: 1.2rem;
            font-weight: 700;
            color: #1f2937;
            margin-bottom: 10px;
        }

        .complex-info {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 0.9rem;
            color: #6b7280;
        }

        .price-info {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            padding: 8px 12px;
            border-radius: 8px;
            text-align: center;
            font-weight: 600;
            margin-top: 10px;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #6b7280;
        }

        .loading::after {
            content: '';
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #e5e7eb;
            border-radius: 50%;
            border-top-color: #3b82f6;
            animation: spin 1s ease-in-out infinite;
            margin-left: 10px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .price-detail-section {
            margin-top: 30px;
            padding: 25px;
            background: white;
            border-radius: 15px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            display: none;
        }

        .price-detail-section.show {
            display: block;
        }

        .price-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .price-table th,
        .price-table td {
            padding: 12px;
            text-align: center;
            border-bottom: 1px solid #e5e7eb;
        }

        .price-table th {
            background: #f8fafc;
            font-weight: 600;
            color: #374151;
        }

        .price-table tr:hover {
            background: #f8fafc;
        }

        .error-message {
            background: #fef2f2;
            border: 1px solid #fecaca;
            color: #dc2626;
            padding: 16px;
            border-radius: 10px;
            margin-top: 20px;
        }

        .success-message {
            background: #f0fdf4;
            border: 1px solid #bbf7d0;
            color: #166534;
            padding: 16px;
            border-radius: 10px;
            margin-top: 20px;
        }

        .loan-check-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .loan-check-modal.show {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 20px;
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 40px rgba(0,0,0,0.2);
            position: relative;
        }

        .modal-header {
            text-align: center;
            margin-bottom: 25px;
        }

        .modal-header h3 {
            color: #1f2937;
            margin-bottom: 10px;
        }

        .selected-price {
            background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
            color: white;
            padding: 10px 20px;
            border-radius: 10px;
            font-size: 1.2rem;
            font-weight: 700;
        }

        .input-group {
            margin-bottom: 20px;
        }

        .input-group label {
            display: block;
            font-weight: 600;
            color: #374151;
            margin-bottom: 8px;
        }

        .input-group input {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e5e7eb;
            border-radius: 10px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }

        .input-group input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .input-hint {
            font-size: 0.85rem;
            color: #6b7280;
            margin-top: 5px;
        }

        .modal-buttons {
            display: flex;
            gap: 15px;
            margin-top: 25px;
        }

        .modal-btn {
            flex: 1;
            padding: 12px 20px;
            border: none;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .modal-btn.primary {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
        }

        .modal-btn.primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 15px rgba(16, 185, 129, 0.3);
        }

        .modal-btn.secondary {
            background: #f3f4f6;
            color: #374151;
        }

        .modal-btn.secondary:hover {
            background: #e5e7eb;
        }

        .close-btn {
            position: absolute;
            top: 15px;
            right: 20px;
            background: none;
            border: none;
            font-size: 1.5rem;
            color: #6b7280;
            cursor: pointer;
            padding: 5px;
        }

        .close-btn:hover {
            color: #374151;
        }

        .result-section {
            margin-top: 25px;
            padding: 20px;
            border-radius: 15px;
            text-align: center;
        }

        .result-section.success {
            background: #f0fdf4;
            border: 2px solid #bbf7d0;
            color: #166534;
        }

        .result-section.warning {
            background: #fffbeb;
            border: 2px solid #fed7aa;
            color: #ea580c;
        }

        .result-section.error {
            background: #fef2f2;
            border: 2px solid #fecaca;
            color: #dc2626;
        }

        .result-title {
            font-size: 1.2rem;
            font-weight: 700;
            margin-bottom: 10px;
        }

        .result-details {
            font-size: 0.95rem;
            line-height: 1.5;
        }

        .price-clickable {
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .price-clickable:hover {
            background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
            color: white;
            transform: scale(1.05);
        }

        @media (max-width: 768px) {
            .search-row {
                flex-direction: column;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .search-section {
                padding: 20px;
            }
            
            .complex-grid {
                grid-template-columns: 1fr;
            }

            .modal-content {
                width: 95%;
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🏠 전세보증보험 가입조건 확인시스템</h1>
            <p>보증금·융자금으로 HUG, SGI 전세보증보험 가입 가능여부를 즉시 확인하세요</p>
        </div>

        <div class="search-section">
            <!-- 지역 선택 -->
            <div class="search-row">
                <div class="search-group">
                    <label for="region-select">지역 선택</label>
                    <select id="region-select">
                        <option value="">지역을 선택하세요</option>
                    </select>
                </div>
                <div class="search-group">
                    <label for="district-select">시/구/군</label>
                    <select id="district-select" disabled>
                        <option value="">지역을 먼저 선택하세요</option>
                    </select>
                </div>
                <div class="search-group">
                    <label for="dong-select">읍/면/동</label>
                    <select id="dong-select" disabled>
                        <option value="">시/구/군을 먼저 선택하세요</option>
                    </select>
                </div>
            </div>

            <!-- 단지 선택 -->
            <div class="search-row">
                <div class="search-group" style="flex: 3;">
                    <label for="complex-select">단지명 선택</label>
                    <select id="complex-select" disabled>
                        <option value="">읍/면/동을 먼저 선택하세요</option>
                    </select>
                </div>
                <div class="search-group">
                    <label>&nbsp;</label>
                    <button class="btn" onclick="searchPrices()" id="search-btn" disabled>
                        시세 조회
                    </button>
                </div>
            </div>

            <!-- 검색 결과 -->
            <div id="results-section" class="results-section">
                <h3>🏢 단지 목록</h3>
                <div id="complex-list" class="complex-grid"></div>
            </div>

            <!-- 시세 상세 -->
            <div id="price-detail-section" class="price-detail-section">
                <div id="price-detail-content"></div>
            </div>
        </div>
    </div>

    <!-- 보증보험 확인 모달 -->
    <div id="loan-check-modal" class="loan-check-modal">
        <div class="modal-content">
            <button class="close-btn" onclick="closeLoanModal()">&times;</button>
            
            <div class="modal-header">
                <h3>🛡️ 보증보험 가입여부 확인</h3>
                <div class="selected-price" id="modal-selected-price">
                    선택된 매매가: 0억
                </div>
                <div style="margin-top: 10px; font-size: 0.9rem; color: #6b7280;">
                    <span id="modal-property-info">면적: - | 평수: - | 타입: -</span>
                </div>
            </div>

            <div class="input-group">
                <label for="deposit-input">보증금 (만원)</label>
                <input type="number" id="deposit-input" placeholder="예: 25000" step="100" min="0">
                <div class="input-hint">보증금을 만원 단위로 입력하세요</div>
                <div id="deposit-display" style="margin-top: 5px; font-size: 0.9rem; color: #059669; font-weight: 600;"></div>
            </div>

            <div class="input-group">
                <label for="loan-input">융자금 (만원)</label>
                <input type="number" id="loan-input" placeholder="예: 120000" step="100" min="0">
                <div class="input-hint">융자받을 금액을 만원 단위로 입력하세요</div>
                <div id="loan-display" style="margin-top: 5px; font-size: 0.9rem; color: #2563eb; font-weight: 600;"></div>
            </div>

            <div class="modal-buttons">
                <button class="modal-btn secondary" onclick="closeLoanModal()">취소</button>
                <button class="modal-btn primary" onclick="checkInsuranceEligibility()">보증보험 가입여부 확인</button>
            </div>

            <div id="loan-result" class="result-section" style="display: none;"></div>
        </div>
    </div>

    <script>
        // 전역 변수
        let dongcodeData = {};
        let currentComplexes = [];
        let selectedComplex = null;
        let selectedPriceValue = 0;

        // 페이지 로드 시 데이터 초기화
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🚀 페이지 로드 완료, 초기화 시작...');
            loadDongcodeData();
        });

        // JSON 데이터 로드
        async function loadDongcodeData() {
            console.log('📂 JSON 데이터 로딩 시작...');
            
            try {
                // 1. 통합 파일 먼저 시도
                console.log('🔍 통합 파일 시도: ./static/combined_dongcode_data.json');
                let response = await fetch('./static/combined_dongcode_data.json');
                
                if (response.ok) {
                    let data = await response.json();
                    console.log('✅ 통합 파일 로드 성공:', data);
                    dongcodeData = data.regions || {};
                    
                    if (Object.keys(dongcodeData).length > 0) {
                        console.log('📊 로드된 지역 데이터:', Object.keys(dongcodeData));
                        populateRegions();
                        return;
                    }
                }
                
                console.log('⚠️ 통합 파일 실패, 개별 파일 시도...');
                
                // 2. 개별 파일들 로드
                const files = [
                    './static/서울_dongcode_data.json', 
                    './static/경기도_dongcode_data.json'
                ];
                
                for (const file of files) {
                    try {
                        console.log(`🔍 개별 파일 시도: ${file}`);
                        const response = await fetch(file);
                        if (response.ok) {
                            const data = await response.json();
                            console.log(`✅ ${file} 로드 성공:`, data);
                            Object.assign(dongcodeData, data.regions || {});
                        } else {
                            console.log(`❌ ${file} 로드 실패: ${response.status}`);
                        }
                    } catch (e) {
                        console.log(`❌ ${file} 오류:`, e);
                    }
                }
                
                if (Object.keys(dongcodeData).length > 0) {
                    console.log('📊 최종 로드된 지역 데이터:', Object.keys(dongcodeData));
                    populateRegions();
                } else {
                    console.error('❌ 모든 JSON 파일 로드 실패');
                    createTestData();
                }
                
            } catch (error) {
                console.error('❌ JSON 로드 전체 실패:', error);
                createTestData();
            }
        }

        // 테스트 데이터 생성
        function createTestData() {
            console.log('🧪 테스트 데이터 생성 중...');
            
            dongcodeData = {
                "서울특별시": {
                    "districts": {
                        "강남구": {
                            "dong_count": 14,
                            "dongs": {
                                "대치동": {
                                    "code": "1168010600",
                                    "fullName": "서울특별시 강남구 대치동"
                                },
                                "역삼동": {
                                    "code": "1168010100", 
                                    "fullName": "서울특별시 강남구 역삼동"
                                },
                                "청담동": {
                                    "code": "1168010400",
                                    "fullName": "서울특별시 강남구 청담동"
                                }
                            }
                        },
                        "서초구": {
                            "dong_count": 10,
                            "dongs": {
                                "반포동": {
                                    "code": "1165010700",
                                    "fullName": "서울특별시 서초구 반포동"
                                },
                                "서초동": {
                                    "code": "1165010800",
                                    "fullName": "서울특별시 서초구 서초동"
                                }
                            }
                        }
                    }
                },
                "경기도": {
                    "districts": {
                        "성남시": {
                            "dong_count": 15,
                            "dongs": {
                                "정자동": {
                                    "code": "4113510900",
                                    "fullName": "경기도 성남시 분당구 정자동"
                                },
                                "서현동": {
                                    "code": "4113511000",
                                    "fullName": "경기도 성남시 분당구 서현동"
                                }
                            }
                        }
                    }
                }
            };
            
            console.log('✅ 테스트 데이터 생성 완료:', dongcodeData);
            populateRegions();
            showError('JSON 파일을 찾을 수 없어서 테스트 데이터를 사용합니다. static/ 폴더에 JSON 파일을 확인해주세요.');
        }

        // 지역 드롭다운 채우기
        function populateRegions() {
            console.log('🔄 지역 드롭다운 초기화 중...');
            
            const regionSelect = document.getElementById('region-select');
            
            if (!regionSelect) {
                console.error('❌ region-select 요소를 찾을 수 없습니다!');
                return;
            }
            
            regionSelect.innerHTML = '';
            
            const defaultOption = document.createElement('option');
            defaultOption.value = '';
            defaultOption.textContent = '지역을 선택하세요';
            regionSelect.appendChild(defaultOption);
            
            console.log('📊 사용 가능한 지역:', Object.keys(dongcodeData));
            
            Object.keys(dongcodeData).forEach(region => {
                console.log(`➕ 지역 추가: ${region}`);
                const option = document.createElement('option');
                option.value = region;
                option.textContent = region;
                regionSelect.appendChild(option);
            });
            
            console.log('✅ 지역 드롭다운 초기화 완료');
            
            if (regionSelect.children.length > 1) {
                regionSelect.disabled = false;
                console.log('✅ 지역 선택 활성화됨');
            } else {
                console.warn('⚠️ 지역 옵션이 추가되지 않았습니다');
            }
        }

        // 지역 선택 시 구/시 업데이트
        document.getElementById('region-select').addEventListener('change', function() {
            const selectedRegion = this.value;
            const districtSelect = document.getElementById('district-select');
            const dongSelect = document.getElementById('dong-select');
            const complexSelect = document.getElementById('complex-select');
            
            districtSelect.innerHTML = '<option value="">시/구/군을 선택하세요</option>';
            dongSelect.innerHTML = '<option value="">읍/면/동을 선택하세요</option>';
            complexSelect.innerHTML = '<option value="">단지를 선택하세요</option>';
            
            dongSelect.disabled = true;
            complexSelect.disabled = true;
            document.getElementById('search-btn').disabled = true;
            
            if (selectedRegion) {
                districtSelect.disabled = false;
                
                const districts = dongcodeData[selectedRegion]?.districts || {};
                // 가나다라 순으로 정렬
                const sortedDistricts = Object.keys(districts).sort((a, b) => a.localeCompare(b, 'ko-KR'));
                
                sortedDistricts.forEach(district => {
                    const option = document.createElement('option');
                    option.value = district;
                    option.textContent = district;
                    districtSelect.appendChild(option);
                });
            } else {
                districtSelect.disabled = true;
            }
            
            hideResults();
        });

        // 구/시 선택 시 동 업데이트
        document.getElementById('district-select').addEventListener('change', function() {
            const selectedRegion = document.getElementById('region-select').value;
            const selectedDistrict = this.value;
            const dongSelect = document.getElementById('dong-select');
            const complexSelect = document.getElementById('complex-select');
            
            dongSelect.innerHTML = '<option value="">읍/면/동을 선택하세요</option>';
            complexSelect.innerHTML = '<option value="">단지를 선택하세요</option>';
            complexSelect.disabled = true;
            document.getElementById('search-btn').disabled = true;
            
            if (selectedDistrict) {
                dongSelect.disabled = false;
                
                const dongs = dongcodeData[selectedRegion]?.districts[selectedDistrict]?.dongs || {};
                // 가나다라 순으로 정렬
                const sortedDongs = Object.keys(dongs).sort((a, b) => a.localeCompare(b, 'ko-KR'));
                
                sortedDongs.forEach(dong => {
                    const option = document.createElement('option');
                    option.value = dong;
                    option.textContent = dong;
                    dongSelect.appendChild(option);
                });
            } else {
                dongSelect.disabled = true;
            }
            
            hideResults();
        });

        // 동 선택 시 단지 목록 로드
        document.getElementById('dong-select').addEventListener('change', function() {
            const selectedRegion = document.getElementById('region-select').value;
            const selectedDistrict = document.getElementById('district-select').value;
            const selectedDong = this.value;
            const complexSelect = document.getElementById('complex-select');
            
            complexSelect.innerHTML = '<option value="">단지를 선택하세요</option>';
            document.getElementById('search-btn').disabled = true;
            
            if (selectedDong) {
                const dongCode = dongcodeData[selectedRegion]?.districts[selectedDistrict]?.dongs[selectedDong]?.code;
                
                if (dongCode) {
                    loadComplexes(dongCode);
                }
            } else {
                complexSelect.disabled = true;
            }
            
            hideResults();
        });

        // 단지 선택 시 검색 버튼 활성화
        document.getElementById('complex-select').addEventListener('change', function() {
            const searchBtn = document.getElementById('search-btn');
            searchBtn.disabled = !this.value;
        });

        // 단지 목록 로드
        async function loadComplexes(dongCode) {
            const complexSelect = document.getElementById('complex-select');
            
            try {
                complexSelect.innerHTML = '<option value="">로딩 중...</option>';
                complexSelect.disabled = true;
                
                console.log(`🔍 단지 조회 시작: 법정동코드 ${dongCode}`);
                
                let complexes = [];
                
                try {
                    // 실제 API 호출 시도
                    const response = await fetch(`https://api.kbland.kr/land-price/price/fastPriceInfo?법정동코드=${dongCode}&유형=1&거래유형=0`, {
                        method: 'GET',
                        headers: {
                            'Accept': 'application/json, text/plain, */*',
                            'Accept-Language': 'ko-KR,ko;q=0.9',
                            'Cache-Control': 'no-cache',
                            'Origin': 'https://kbland.kr',
                            'Referer': 'https://kbland.kr/'
                        },
                        mode: 'cors'
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        complexes = data.dataBody?.data || [];
                        console.log(`✅ API 직접 호출 성공: ${complexes.length}개 단지`);
                    }
                } catch (corsError) {
                    console.log('⚠️ CORS 오류로 API 직접 호출 실패, 테스트 데이터 사용');
                    complexes = getTestComplexes(dongCode);
                    console.log(`🧪 테스트 데이터 사용: ${complexes.length}개 단지`);
                }
                
                currentComplexes = complexes;
                
                complexSelect.innerHTML = '<option value="">단지를 선택하세요</option>';
                
                if (complexes.length > 0) {
                    // 단지명으로 정렬 (숫자 고려)
                    const sortedComplexes = [...complexes].sort((a, b) => {
                        const nameA = a.단지명 || a.name || '이름 없음';
                        const nameB = b.단지명 || b.name || '이름 없음';
                        
                        // 단지명에서 기본 이름과 숫자 분리
                        const parseComplex = (name) => {
                            const match = name.match(/^(.+?)(\d+)(.*)$/);
                            if (match) {
                                return {
                                    baseName: match[1],
                                    number: parseInt(match[2]),
                                    suffix: match[3]
                                };
                            }
                            return { baseName: name, number: 0, suffix: '' };
                        };
                        
                        const parsedA = parseComplex(nameA);
                        const parsedB = parseComplex(nameB);
                        
                        // 1차: 기본 이름으로 정렬
                        const baseCompare = parsedA.baseName.localeCompare(parsedB.baseName, 'ko-KR');
                        if (baseCompare !== 0) return baseCompare;
                        
                        // 2차: 숫자로 정렬
                        return parsedA.number - parsedB.number;
                    });
                    
                    sortedComplexes.forEach((complex, index) => {
                        const option = document.createElement('option');
                        option.value = complexes.indexOf(complex); // 원본 배열에서의 인덱스 유지
                        option.textContent = complex.단지명 || complex.name || '이름 없음';
                        complexSelect.appendChild(option);
                    });
                    
                    complexSelect.disabled = false;
                    console.log(`✅ 단지 드롭다운 업데이트 완료: ${complexes.length}개`);
                } else {
                    complexSelect.innerHTML = '<option value="">해당 지역에 단지가 없습니다</option>';
                    console.log('⚠️ 단지 없음');
                }
                
            } catch (error) {
                console.error('❌ 단지 로드 전체 오류:', error);
                complexSelect.innerHTML = '<option value="">단지 로드 실패</option>';
                showError('단지 목록을 불러오는데 실패했습니다. CORS 문제일 수 있습니다.');
            }
        }

        // 테스트 단지 데이터 생성
        function getTestComplexes(dongCode) {
            const testData = {
                "1168010600": [ // 대치동
                    {
                        "단지명": "대치아이파크",
                        "단지기본일련번호": "341954",
                        "세대수": 848,
                        "준공년도": "2007",
                        "매매평균가": "148750",
                        "wgs84위도": 37.494567,
                        "wgs84경도": 127.059123
                    },
                    {
                        "단지명": "대치우성아파트",
                        "단지기본일련번호": "341955",
                        "세대수": 420,
                        "준공년도": "1995",
                        "매매평균가": "125000"
                    },
                    {
                        "단지명": "대치현대2차아파트",
                        "단지기본일련번호": "341956",
                        "세대수": 756,
                        "준공년도": "1993",
                        "매매평균가": "135000"
                    }
                ],
                "1168010100": [ // 역삼동
                    {
                        "단지명": "역삼롯데캐슬",
                        "단지기본일련번호": "341960",
                        "세대수": 580,
                        "준공년도": "2005",
                        "매매평균가": "142000"
                    }
                ],
                "1165010700": [ // 반포동
                    {
                        "단지명": "반포자이",
                        "단지기본일련번호": "341970",
                        "세대수": 1200,
                        "준공년도": "2009",
                        "매매평균가": "165000"
                    }
                ]
            };
            
            return testData[dongCode] || [
                {
                    "단지명": "테스트아파트",
                    "단지기본일련번호": "999999",
                    "세대수": 500,
                    "준공년도": "2010",
                    "매매평균가": "100000"
                }
            ];
        }

        // 시세 조회
        async function searchPrices() {
            const complexIndex = document.getElementById('complex-select').value;
            
            if (!complexIndex || !currentComplexes[complexIndex]) {
                showError('단지를 선택해주세요.');
                return;
            }
            
            selectedComplex = currentComplexes[complexIndex];
            
            try {
                showLoading();
                console.log(`💰 시세 조회 시작: ${selectedComplex.단지명}`);
                
                let detailData = null;
                
                try {
                    // 실제 API 시도
                    const detailResponse = await fetch(`https://api.kbland.kr/land-complex/complex/mpriByType?단지기본일련번호=${selectedComplex.단지기본일련번호}`, {
                        headers: {
                            'Accept': 'application/json, text/plain, */*',
                            'Origin': 'https://kbland.kr',
                            'Referer': 'https://kbland.kr/'
                        }
                    });
                    
                    if (detailResponse.ok) {
                        const data = await detailResponse.json();
                        detailData = data.dataBody?.data;
                        console.log('✅ 실제 API 시세 조회 성공');
                    }
                } catch (apiError) {
                    console.log('⚠️ API 호출 실패, 테스트 데이터 사용');
                    detailData = getTestPriceData(selectedComplex.단지기본일련번호);
                    console.log('🧪 테스트 시세 데이터 사용');
                }
                
                displayPriceDetails(selectedComplex, detailData);
                
            } catch (error) {
                console.error('❌ 시세 조회 전체 오류:', error);
                showError('시세 정보를 불러오는데 실패했습니다.');
            }
        }

        // 테스트 시세 데이터 생성
        function getTestPriceData(complexId) {
            const testPriceData = {
                "341954": [ // 대치아이파크
                    {
                        "공급면적": "84.93",
                        "공급면적평N": "25.7",
                        "주택형타입내용": "84A형",
                        "매매일반거래가": "148750"
                    },
                    {
                        "공급면적": "84.93", 
                        "공급면적평N": "25.7",
                        "주택형타입내용": "84B형",
                        "매매일반거래가": "151250"
                    },
                    {
                        "공급면적": "114.93",
                        "공급면적평N": "34.8", 
                        "주택형타입내용": "114A형",
                        "매매일반거래가": "192500"
                    },
                    {
                        "공급면적": "114.93",
                        "공급면적평N": "34.8",
                        "주택형타입내용": "114B형", 
                        "매매일반거래가": "198750"
                    },
                    {
                        "공급면적": "134.85",
                        "공급면적평N": "40.8",
                        "주택형타입내용": "134A형",
                        "매매일반거래가": "235000"
                    }
                ]
            };
            
            return testPriceData[complexId] || [
                {
                    "공급면적": "84.0",
                    "공급면적평N": "25.4",
                    "주택형타입내용": "84형",
                    "매매일반거래가": "100000"
                }
            ];
        }

        // 시세 상세 정보 표시
        function displayPriceDetails(complex, detailData) {
            const section = document.getElementById('price-detail-section');
            const contentElement = document.getElementById('price-detail-content');
            
            let content = '';
            
            if (detailData && Array.isArray(detailData) && detailData.length > 0) {
                // 매매가가 있는 데이터만 필터링
                const filteredData = detailData.filter(item => {
                    const price = item.매매일반거래가 || item.매매가 || item.매매평균가;
                    return price && price !== '' && price !== '-' && price !== 'N/A' && price !== 0;
                });
                
                if (filteredData.length > 0) {
                    // 평형별 시세 데이터 정렬
                    const sortedDetailData = [...filteredData].sort((a, b) => {
                        const pyeongA = parseFloat(a.공급면적평N || a.평수 || 0);
                        const pyeongB = parseFloat(b.공급면적평N || b.평수 || 0);
                        
                        // 1차: 평수 순으로 정렬
                        if (pyeongA !== pyeongB) {
                            return pyeongA - pyeongB;
                        }
                        
                        // 2차: 같은 평수이면 주택형타입내용을 알파벳+숫자순으로 정렬
                        const typeA = (a.주택형타입내용 || a.타입 || a.주택형 || '').toString().trim();
                        const typeB = (b.주택형타입내용 || b.타입 || b.주택형 || '').toString().trim();
                        
                        // 타입에서 알파벳과 숫자 분리해서 정렬
                        const parseType = (type) => {
                            // 알파벳과 숫자를 분리하는 정규식
                            const match = type.match(/([A-Za-z]*)(\d*)(.*)/);
                            return {
                                letter: match[1] || '',
                                number: parseInt(match[2]) || 0,
                                rest: match[3] || ''
                            };
                        };
                        
                        const parsedA = parseType(typeA);
                        const parsedB = parseType(typeB);
                        
                        // 먼저 알파벳으로 비교
                        const letterCompare = parsedA.letter.localeCompare(parsedB.letter);
                        if (letterCompare !== 0) {
                            return letterCompare;
                        }
                        
                        // 알파벳이 같으면 숫자로 비교
                        if (parsedA.number !== parsedB.number) {
                            return parsedA.number - parsedB.number;
                        }
                        
                        // 나머지 부분으로 비교
                        return parsedA.rest.localeCompare(parsedB.rest);
                    });
                    
                    content += `
                        <h4 style="margin-bottom: 15px; color: #1f2937;">💰 평형별 매매 시세</h4>
                        <div style="overflow-x: auto;">
                            <table class="price-table">
                                <thead>
                                    <tr>
                                        <th>No</th>
                                        <th>면적(m²)</th>
                                        <th>평수</th>
                                        <th>타입</th>
                                        <th>매매가</th>
                                    </tr>
                                </thead>
                                <tbody>
                    `;
                    
                    sortedDetailData.slice(0, 20).forEach((item, index) => {
                        const area = item.공급면적 || item.면적 || '-';
                        const pyeong = item.공급면적평N || item.평수 || '-';
                        const type = item.주택형타입내용 || item.타입 || item.주택형 || '-';
                        const price = item.매매일반거래가 || item.매매가 || item.매매평균가 || '-';
                        
                        content += `
                            <tr style="cursor: pointer;" onclick="openInsuranceModal('${price}', '${area}', '${pyeong}', '${type}')" onmouseover="this.style.backgroundColor='#f3f4f6'" onmouseout="this.style.backgroundColor=''">
                                <td>${index + 1}</td>
                                <td>${area}</td>
                                <td>${pyeong}</td>
                                <td>${type}</td>
                                <td><strong>${formatPrice(price)}</strong></td>
                            </tr>
                        `;
                    });
                    
                    content += `
                                </tbody>
                            </table>
                        </div>
                    `;
                    
                    if (sortedDetailData.length > 20) {
                        content += `<p style="text-align: center; margin-top: 15px; color: #6b7280;">... 외 ${sortedDetailData.length - 20}개 타입 더 있음</p>`;
                    }
                } else {
                    content += `
                        <div class="error-message">
                            상세 시세 정보를 불러올 수 없습니다. 기본 정보만 표시됩니다.
                        </div>
                    `;
                }
            } else {
                content += `
                    <div class="error-message">
                        상세 시세 정보를 불러올 수 없습니다. 기본 정보만 표시됩니다.
                    </div>
                `;
            }
            
            contentElement.innerHTML = content;
            section.classList.add('show');
            
            section.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        // 보증보험 확인 모달 열기
        function openInsuranceModal(price, area, pyeong, type) {
            if (!price || price === '-') {
                showError('가격 정보가 없습니다.');
                return;
            }
            
            selectedPriceValue = parseNumericPrice(price);
            
            if (selectedPriceValue <= 0) {
                showError('올바른 가격 정보가 아닙니다.');
                return;
            }
            
            const modalPrice = document.getElementById('modal-selected-price');
            modalPrice.textContent = `선택된 매매가: ${formatPrice(selectedPriceValue)}`;
            
            const modalInfo = document.getElementById('modal-property-info');
            modalInfo.textContent = `면적: ${area}m² | 평수: ${pyeong}평 | 타입: ${type}`;
            
            const depositInput = document.getElementById('deposit-input');
            const loanInput = document.getElementById('loan-input');
            
            depositInput.value = '';
            loanInput.value = '';
            document.getElementById('loan-result').style.display = 'none';
            document.getElementById('deposit-display').textContent = '';
            document.getElementById('loan-display').textContent = '';
            
            // 실시간 금액 표시 이벤트 리스너 추가
            depositInput.addEventListener('input', updateDepositDisplay);
            loanInput.addEventListener('input', updateLoanDisplay);
            
            document.getElementById('loan-check-modal').classList.add('show');
        }

        // 보증금 실시간 표시 업데이트
        function updateDepositDisplay() {
            const depositInput = document.getElementById('deposit-input');
            const depositDisplay = document.getElementById('deposit-display');
            const value = parseFloat(depositInput.value) || 0;
            
            if (value > 0) {
                depositDisplay.textContent = `💰 ${formatPrice(value)}`;
            } else {
                depositDisplay.textContent = '';
            }
        }

        // 융자금 실시간 표시 업데이트
        function updateLoanDisplay() {
            const loanInput = document.getElementById('loan-input');
            const loanDisplay = document.getElementById('loan-display');
            const value = parseFloat(loanInput.value) || 0;
            
            if (value > 0) {
                loanDisplay.textContent = `🏦 ${formatPrice(value)}`;
            } else {
                loanDisplay.textContent = '';
            }
        }

        // 대출 확인 모달 닫기
        function closeLoanModal() {
            document.getElementById('loan-check-modal').classList.remove('show');
        }
        // 보증보험 가입여부 확인
        async function checkInsuranceEligibility() {
            const depositInput = document.getElementById('deposit-input');
            const loanInput = document.getElementById('loan-input');
            const resultDiv = document.getElementById('loan-result');
            
            const deposit = parseFloat(depositInput.value) || 0;  // 만원 단위
            const loan = parseFloat(loanInput.value) || 0;        // 만원 단위
            
            if (deposit <= 0 && loan <= 0) {
                showModalError('보증금 또는 융자금을 입력해주세요.');
                return;
            }
            
            // 매매가를 만원 단위로 변환
            const salePriceWon = selectedPriceValue; // 이미 만원 단위
            const totalAmount = deposit + loan;
            const loanRatio = (loan / salePriceWon) * 100; // 융자금 비율
            const totalRatio = (totalAmount / salePriceWon) * 100; // 총 비율
            
            // HUG 보증보험 조건 확인 (억원 단위로 변환해서 체크)
            const hugCondition1 = loanRatio <= 60; // 융자금 60% 이내
            const hugCondition2 = totalRatio <= 90; // 총합 90% 이내
            const hugCondition3 = deposit <= 70000; // 보증금 7억 이하 (7억 = 70000만원)
            const hugEligible = hugCondition1 && hugCondition2 && hugCondition3;
            
            // SGI서울보증 조건 확인
            const sgiCondition1 = totalRatio <= 100; // 총합 100% 이내
            const sgiEligible = sgiCondition1;
            
            let resultHtml = '';
            let resultClass = '';
            
            if (hugEligible && sgiEligible) {
                // 둘 다 가능한 경우 - "보증보험 가능"으로 표시
                resultClass = 'success';
                resultHtml = `
                    <div class="result-title">✅ 보증보험 가능</div>
                    <div class="result-details">
                        <p><strong>매매가:</strong> ${formatPrice(salePriceWon)}</p>
                        <p><strong>보증금:</strong> ${formatPrice(deposit)}</p>
                        <p><strong>융자금:</strong> ${formatPrice(loan)} (${loanRatio.toFixed(1)}%)</p>
                        <p><strong>총 금액:</strong> ${formatPrice(totalAmount)} (${totalRatio.toFixed(1)}%)</p>
                        <hr style="margin: 10px 0; border: none; border-top: 1px solid #e5e7eb;">
                        
                        <div style="background: #f0fdf4; padding: 12px; border-radius: 8px; margin-bottom: 10px;">
                            <p style="color: #059669; font-weight: 600;">🏛️ HUG(주택도시보증공사) 가능</p>
                            <div style="font-size: 0.85rem; margin-top: 5px; color: #374151;">
                                <p>✅ 융자금 ${loanRatio.toFixed(1)}% (60% 이내)</p>
                                <p>✅ 총 금액 ${totalRatio.toFixed(1)}% (90% 이내)</p>
                                <p>✅ 보증금 ${formatPrice(deposit)} (7억 이하)</p>
                            </div>
                        </div>
                        
                        <div style="background: #eff6ff; padding: 12px; border-radius: 8px;">
                            <p style="color: #2563eb; font-weight: 600;">🏢 SGI서울보증 가능</p>
                            <div style="font-size: 0.85rem; margin-top: 5px; color: #374151;">
                                <p>✅ 총 금액 ${totalRatio.toFixed(1)}% (100% 이내)</p>
                                <p>✅ 보증금 한도 제한 없음</p>
                            </div>
                        </div>
                        
                        <p style="font-size: 0.85rem; margin-top: 10px; color: #6b7280;">※ 두 보증보험 모두 이용 가능하므로 조건을 비교해서 선택하세요.</p>
                    </div>
                `;
            } else if (hugEligible) {
                // HUG만 가능한 경우 - "보증보험 가능"으로 표시
                resultClass = 'success';
                resultHtml = `
                    <div class="result-title">✅ 보증보험 가능</div>
                    <div class="result-details">
                        <p><strong>매매가:</strong> ${formatPrice(salePriceWon)}</p>
                        <p><strong>보증금:</strong> ${formatPrice(deposit)}</p>
                        <p><strong>융자금:</strong> ${formatPrice(loan)} (${loanRatio.toFixed(1)}%)</p>
                        <p><strong>총 금액:</strong> ${formatPrice(totalAmount)} (${totalRatio.toFixed(1)}%)</p>
                        <hr style="margin: 10px 0; border: none; border-top: 1px solid #e5e7eb;">
                        
                        <div style="background: #f0fdf4; padding: 12px; border-radius: 8px;">
                            <p style="color: #059669; font-weight: 600;">🏛️ HUG(주택도시보증공사) 가능</p>
                            <div style="font-size: 0.85rem; margin-top: 5px; color: #374151;">
                                <p>✅ 융자금 ${loanRatio.toFixed(1)}% (60% 이내)</p>
                                <p>✅ 총 금액 ${totalRatio.toFixed(1)}% (90% 이내)</p>
                                <p>✅ 보증금 ${formatPrice(deposit)} (7억 이하)</p>
                            </div>
                        </div>
                        
                        <p style="font-size: 0.85rem; margin-top: 10px; color: #6b7280;">※ SGI서울보증은 총 금액이 100%를 초과하여 이용 불가합니다.</p>
                    </div>
                `;
            } else if (sgiEligible) {
                // SGI만 가능한 경우 - "SGI서울보증만 가능"으로 표시
                resultClass = 'warning';
                resultHtml = `
                    <div class="result-title">⚠️ SGI서울보증만 가능</div>
                    <div class="result-details">
                        <p><strong>매매가:</strong> ${formatPrice(salePriceWon)}</p>
                        <p><strong>보증금:</strong> ${formatPrice(deposit)}</p>
                        <p><strong>융자금:</strong> ${formatPrice(loan)} (${loanRatio.toFixed(1)}%)</p>
                        <p><strong>총 금액:</strong> ${formatPrice(totalAmount)} (${totalRatio.toFixed(1)}%)</p>
                        <hr style="margin: 10px 0; border: none; border-top: 1px solid #e5e7eb;">
                        
                        <div style="background: #eff6ff; padding: 12px; border-radius: 8px;">
                            <p style="color: #2563eb; font-weight: 600;">🏢 SGI서울보증 가능</p>
                            <div style="font-size: 0.85rem; margin-top: 5px; color: #374151;">
                                <p>✅ 총 금액 ${totalRatio.toFixed(1)}% (100% 이내)</p>
                                <p>✅ 보증금 한도 제한 없음</p>
                            </div>
                        </div>
                        
                        <div style="background: #fef2f2; padding: 12px; border-radius: 8px; margin-top: 10px;">
                            <p style="color: #dc2626; font-weight: 600;">❌ HUG 보증보험 불가 사유:</p>
                            <div style="font-size: 0.85rem; margin-top: 5px; color: #374151;">
                                ${!hugCondition1 ? `<p>• 융자금 ${loanRatio.toFixed(1)}% (60% 초과)</p>` : ''}
                                ${!hugCondition2 ? `<p>• 총 금액 ${totalRatio.toFixed(1)}% (90% 초과)</p>` : ''}
                                ${!hugCondition3 ? `<p>• 보증금 ${formatPrice(deposit)} (7억 초과)</p>` : ''}
                            </div>
                        </div>
                        
                        <p style="font-size: 0.85rem; margin-top: 10px; color: #ea580c;">※ SGI서울보증으로만 보증보험 가입이 가능합니다.</p>
                    </div>
                `;
            } else {
                // 둘 다 불가능한 경우
                resultClass = 'error';
                resultHtml = `
                    <div class="result-title">❌ 보증보험 가입 불가</div>
                    <div class="result-details">
                        <p><strong>매매가:</strong> ${formatPrice(salePriceWon)}</p>
                        <p><strong>보증금:</strong> ${formatPrice(deposit)}</p>
                        <p><strong>융자금:</strong> ${formatPrice(loan)} (${loanRatio.toFixed(1)}%)</p>
                        <p><strong>총 금액:</strong> ${formatPrice(totalAmount)} (${totalRatio.toFixed(1)}%)</p>
                        <hr style="margin: 10px 0; border: none; border-top: 1px solid #e5e7eb;">
                        <div style="background: #fef2f2; padding: 12px; border-radius: 8px; margin-bottom: 10px;">
                            <p style="color: #dc2626; font-weight: 600;">❌ HUG(주택도시보증공사) 불가 사유:</p>
                            <div style="font-size: 0.85rem; margin-top: 5px;">
                                ${!hugCondition1 ? `<p>• 융자금 ${loanRatio.toFixed(1)}% (60% 초과)</p>` : ''}
                                ${!hugCondition2 ? `<p>• 총 금액 ${totalRatio.toFixed(1)}% (90% 초과)</p>` : ''}
                                ${!hugCondition3 ? `<p>• 보증금 ${formatPrice(deposit)} (7억 초과)</p>` : ''}
                            </div>
                        </div>
                        <div style="background: #fef2f2; padding: 12px; border-radius: 8px;">
                            <p style="color: #dc2626; font-weight: 600;">❌ SGI서울보증 불가 사유:</p>
                            <div style="font-size: 0.85rem; margin-top: 5px;">
                                <p>• 총 금액 ${totalRatio.toFixed(1)}% (100% 초과)</p>
                            </div>
                        </div>
                        <div style="font-size: 0.85rem; margin-top: 15px; color: #374151; background: #f8fafc; padding: 10px; border-radius: 6px;">
                            <p><strong>📋 가입 조건 요약:</strong></p>
                            <p><strong>HUG:</strong> 융자금 60% 이내 + 총금액 90% 이내 + 보증금 7억 이하</p>
                            <p><strong>SGI:</strong> 총금액 100% 이내 (보증금 한도 없음)</p>
                        </div>
                        <p style="font-size: 0.85rem; margin-top: 10px; font-weight: 600; color: #dc2626;">💡 보증금이나 융자금을 조정해보세요.</p>
                    </div>
                `;
            }
            
            resultDiv.className = `result-section ${resultClass}`;
            resultDiv.innerHTML = resultHtml;
            resultDiv.style.display = 'block';
            
            // ✨ Notion Database에 단지명만 저장 (새로 추가된 부분)
            await saveComplexToNotion(selectedComplex?.단지명 || '알 수 없는 단지');
        }

        // Notion Database에 전체 데이터 저장 함수 (업데이트)
        async function saveComplexToNotion(complexName) {
            try {
                console.log('💾 Notion 저장 시작:', complexName);
                
                // 현재 모달에서 정보 추출
                const modalInfo = document.getElementById('modal-property-info');
                const text = modalInfo ? modalInfo.textContent : '';
                
                const areaMatch = text.match(/면적: ([^|]+)/);
                const pyeongMatch = text.match(/평수: ([^|]+)/);
                const typeMatch = text.match(/타입: (.+)$/);
                
                const area = areaMatch ? areaMatch[1].trim() : '';
                const pyeong = pyeongMatch ? pyeongMatch[1].trim().replace('평', '') : '';
                const type = typeMatch ? typeMatch[1].trim() : '';
                
                // 입력된 보증금/융자금 가져오기
                const depositInput = document.getElementById('deposit-input');
                const loanInput = document.getElementById('loan-input');
                const deposit = parseFloat(depositInput?.value) || 0;
                const loan = parseFloat(loanInput?.value) || 0;
                
                // 결과 판단
                const salePriceWon = selectedPriceValue;
                const totalAmount = deposit + loan;
                const loanRatio = (loan / salePriceWon) * 100;
                const totalRatio = (totalAmount / salePriceWon) * 100;
                
                const hugEligible = loanRatio <= 60 && totalRatio <= 90 && deposit <= 70000;
                const sgiEligible = totalRatio <= 100;
                
                let result = 'impossible';
                if (hugEligible && sgiEligible) {
                    result = 'both_possible';
                } else if (hugEligible) {
                    result = 'both_possible'; // HUG만 가능해도 "가능"으로 표시
                } else if (sgiEligible) {
                    result = 'sgi_only';
                }
                
                const response = await fetch('/api/save-complex', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        complexName: complexName,
                        area: area,
                        pyeong: pyeong,
                        type: type,
                        salePrice: salePriceWon, // 만원 단위
                        deposit: deposit, // 만원 단위
                        loan: loan, // 만원 단위
                        result: result
                    })
                });
                
                console.log('📡 API 응답 상태:', response.status);
                
                const resultData = await response.json();
                console.log('📋 API 응답 데이터:', resultData);
                
                if (resultData.success) {
                    console.log('✅ 전체 데이터 저장 성공:', resultData.savedData);
                } else {
                    console.error('⚠️ 데이터 저장 실패:', resultData.message);
                    console.error('상세 오류:', resultData.error);
                }
                
            } catch (error) {
                console.error('❌ 데이터 저장 오류:', error);
                console.error('오류 상세:', error.message);
            }
        }
        // 숫자 가격으로 변환
        function parseNumericPrice(price) {
            if (typeof price === 'number') {
                return price;
            }
            
            if (typeof price === 'string') {
                const numStr = price.replace(/[^0-9.]/g, '');
                const num = parseFloat(numStr);
                
                if (isNaN(num)) return 0;
                
                if (price.includes('억')) {
                    return num * 10000;
                } else if (price.includes('만')) {
                    return num;
                } else {
                    return num;
                }
            }
            
            return 0;
        }

        // 억원 단위로 포맷팅
        function formatPriceEok(price) {
            if (price === 0) return '0억';
            
            if (price === Math.floor(price)) {
                return `${Math.floor(price)}억`;
            } else {
                return `${price.toFixed(1)}억`;
            }
        }

        // 가격 포맷팅
        function formatPrice(price) {
            if (!price || price === '' || price === 0) {
                return '-';
            }
            
            try {
                let priceNum;
                
                if (typeof price === 'string') {
                    const cleanPrice = price.replace(/[,\s]/g, '');
                    if (!/^\d*\.?\d+$/.test(cleanPrice)) {
                        return price;
                    }
                    priceNum = parseFloat(cleanPrice);
                } else if (typeof price === 'number') {
                    priceNum = price;
                } else {
                    return price.toString();
                }
                
                if (priceNum >= 10000) {
                    const eokValue = priceNum / 10000;
                    if (eokValue === Math.floor(eokValue)) {
                        return `${Math.floor(eokValue)}억`;
                    } else {
                        return `${eokValue.toString()}억`;
                    }
                } else {
                    if (priceNum === Math.floor(priceNum)) {
                        return `${Math.floor(priceNum).toLocaleString()}만원`;
                    } else {
                        return `${priceNum.toString()}만원`;
                    }
                }
            } catch (error) {
                return price.toString();
            }
        }

        // 로딩 표시
        function showLoading() {
            const section = document.getElementById('price-detail-section');
            const contentElement = document.getElementById('price-detail-content');
            
            contentElement.innerHTML = '<div class="loading">시세 정보를 조회하고 있습니다</div>';
            section.classList.add('show');
        }

        // 결과 숨기기
        function hideResults() {
            document.getElementById('results-section').classList.remove('show');
            document.getElementById('price-detail-section').classList.remove('show');
        }

        // 에러 메시지 표시
        function showError(message) {
            const section = document.getElementById('price-detail-section');
            const contentElement = document.getElementById('price-detail-content');
            
            contentElement.innerHTML = `<div class="error-message">${message}</div>`;
            section.classList.add('show');
        }

        // ESC 키로 모달 닫기
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                closeLoanModal();
            }
        });

        // 모달 배경 클릭으로 닫기
        document.getElementById('loan-check-modal').addEventListener('click', function(event) {
            if (event.target === this) {
                closeLoanModal();
            }
        });
    </script>
</body>
</html>
